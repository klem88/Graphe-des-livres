<!DOCTYPE html>
<meta charset="utf-8">
<title>Force Layout Example 1</title>	
<style>


/*.allnodes circle {
	stroke: #fff; 
	stroke-width: 1px;
}*/

.nodetext{
	font-size: 50%;
}

#flexcontainer0 {
	
	display: flex;	
	flex-direction: row;
	flex-wrap: nowrap;
}

#flexcontainer1 {
	
	display: flex;	
	flex-direction: column;
	flex-wrap: nowrap;
}

#flexcontainer2 {
	
	display: flex;	
	flex-direction: column;
}

.flexelement {
	border : solid;
	border-width: 1px;
	border-radius : 25px;
	border-color : grey;
}

#textname2 {
	font-size: 150%;
}

img {
	margin-left: 5px;
	margin-right: 5px;
}

label {
	font-size: 100%;
}

div {
	margin: 5px;
}

ul {
	margin: 0px;
	padding: 10px;
}

h4 {
	text-align: center;
}

</style>

<body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.3.0/d3.min.js"></script>

<script>

var dataset = "graphe4.json";

var linkupd, groupnodeenter, groupnode, pathupd;
var clickedgroups = [], groupsplit = [], nodecoordinates = [500, 500];
var initlinks = [];
var initdetlinks = [];
var viznodes = [];
var vizlinks = [];
var vizlinksdetails = [];
var nodeslinksrange = [2, 8];
var nodesradiusrange = [4, 18];
var nodesradiusonhover = 60;
var linkopacity_off = 0.1;
var linkopacity_on = 0.6;
var pathopacity_off = 0.5;
var labelopacity_off = 0.4;
var labelopacity_on = 1;
var hull_offset = 30;
var start_nb = 0;
var linkvalue = 25;
var paramlinklabel = 0;
var allwhat = 'All books';
var nodevalue = [allwhat];
var publivalue = ['All publishers'];
var centroid = {};
var trans = d3.transition().duration(2000);
var coverwidth = 50;
var coverheight = 50;
var spacebtw2covers = 55;
var cover_y = 5;
var forcestrength;
var nbcoverstoshow = 15;
var minlinkvaluewithall = 10;
var nbcharintitle = 20;
var minforcestrength = 0.02;

var flexcontainer0 = d3
	.select('body')
	.append('div')
	.attr('id', 'flexcontainer0');
	//.style('text-align', 'center');

var flexcontainer1 = flexcontainer0
	.append('div')
	.attr('id', 'flexcontainer1')
	//.style('text-align', 'center')
	.style('flex-grow', '1');

var flexcontainer2 = flexcontainer0
	.append('div')
	.attr('id', 'flexcontainer2')
	.style('flex-grow', '4');
	//.style('text-align', 'left');

flexcontainer1
	.append('div')
	.attr('class', 'flexelement')
	.attr('id', 'filternbbooks')
	.style('text-align', 'center')
	.append('h4')
	.text('Number of institutions:');

d3
	.select('#filternbbooks')
	.append('p')
	.attr('id', 'textname2')
	.text("-");

d3
	.select('#filternbbooks')
	.append('label')
	.attr('for', 'paramlinkvalue')
	.html('Min institutions shared btw 2 books: <br>')
	.append('input')
	.attr('type', 'number')
	.attr('id', 'paramlinklabel');

d3
	.select('#filternbbooks')
	.append('span')
	.html('<br>');

d3
	.select('#filternbbooks')
	.append('input')
	.attr('type', 'range')
	.attr('id', 'paramlinkvalue');

flexcontainer1
	.append('div')
	.attr('class', 'flexelement')
	.attr('id', 'filteriid')
	.append('h4')
	.text("Books' titles:");

d3
	.select('#filteriid')
	.append('ul')
	.style('list-style-type', 'none')
	.attr('id', 'paraminstitution');

flexcontainer1
	.append('div')
	.attr('class', 'flexelement')
	.attr('id', 'filterpublishers')
	.append('h4')
	.text('Publisher name:');

d3
	.select('#filterpublishers')
	.append('ul')
	.style('list-style-type', 'none')
	.attr('id', 'parampublishers');

/*flexcontainer2
	.append('div')
	.attr('class', 'flexelement')
	.attr('id', 'bookscovers')
	.style('text-align', 'center')	
	//.style('flex-grow', '4')
	.append('h4')
	.text("Most popular books in teachers' bookshelves:");
*/
flexcontainer2
	.append('div')
	.attr('id', 'graph');
	//.style('flex-grow', '4');

var width = parseInt(d3.select('#graph').style('width'), 10)  , //1000
	height = 700;

d3
	.select('#graph')
	.append('svg')
	.attr('id', 'svggraph')
	.attr('width', width)
	.attr('height', height);

var svg = d3
	.select("#svggraph");

svg
	.append("g")
	.attr("class", "alllinks");

svg
	.append("g")
	.attr("class", "hulls");

svg
	.append("g")
	.attr("class", "allnodes");

svg
	.append("g")
	.attr("class", "alltextnodes");

svg
	.append("g")
	.attr("class", "allcovers");

var color = d3.scaleOrdinal(d3.schemeCategory20);
var iidcolor = d3.scaleOrdinal(d3.schemeCategory20);

var simulation = d3
	.forceSimulation()
	.force(
		"link", d3
			.forceLink()
			.distance(function(d) {
				return 1 / d.value;//1 / linkscale(d.value);
			//	if (d.source.group == d.target.group) { return 10 ;} else { return (500 / d.value); };
			})
			.strength(function(d){
				console.log(forcestrength());
				return forcestrength();
				//if (d.source.group == d.target.group) { return 1; } else { return forcestrength(); }
			})
			.id(function(d) {return d.id; }) //Permet de faire le lien entre Nodes et Links (by "id")
	)
	.force(
		"charge", d3
			.forceManyBody()
			//.distanceMax(400)
			// Inutile d'insérer une fonction ci-dessous car la charge n'est dépendante que d'un node à la fois
			.strength(function(d){
				return -1;
				//if (clickedgroups.includes(d.group)) {return -1000} else {return -5000};
			})
		)

	.force("center", d3.forceCenter(width / 2, height / 2))
	.force("collide",d3.forceCollide( function(d) { return nodescale(d.nodesize) + 25; } ).strength(1).iterations(1) )
	//.force("x", d3.forceX().x(function(d){ if(centroid[d.group] != undefined) {return centroid[d.group][0]} else {return null}; }).strength(0.2))
	//.force("y", d3.forceY().y(function(d){ if(centroid[d.group] != undefined) {return centroid[d.group][1]} else {return null}; }).strength(0.2))
	.alphaMin(.01)
	.alphaDecay(.02);

// FUNCTION THAT UPDATES THE DATASET //

function update(viznodes, vizlinks, vizlinksdetails, data) {	

	minlinkvalue = function() {if (publivalue.includes('All publishers') && nodevalue.includes(allwhat)) { return minlinkvaluewithall; } 
			else { return d3.min(vizlinks.map(function(d){ return d.value; })); }};
	maxlinkvalue = d3.max(vizlinks.map(function(d){ return d.value; }));

	linkvalue = d3.max([linkvalue, minlinkvalue()]);

	function filter(arraytofilter){
		return arraytofilter.filter(function(d){
			if (d.source.id === undefined) { var source = d.source } else { var source = d.source.id };
			if (d.target.id === undefined) { var target = d.target } else { var target = d.target.id };
			if (nodevalue.includes(allwhat)) {return d.value >= linkvalue} else
				if (nodevalue.length == 1) {return d.value >= linkvalue && ( nodevalue.includes(source) || nodevalue.includes(target) );} else {
					//Filtre OU - All links containing either source or target are displayed
					return d.value >= linkvalue && ( nodevalue.includes(source) || nodevalue.includes(target) );
					//Filtre ET - Only links containing source and target is displayed (from two selected iid)
					//return d.value >= linkvalue && ( nodevalue.includes(source) && nodevalue.includes(target) );
				}
		});
	};

	function coveronmouseover(a, coverstoshow) {
		var temp = viznodesdetails.filter(function(c){ return c.institution == a});
		temp = temp.map(function(c){ return c.id; } );
		d3
			.selectAll('.onenode')
			.attr("fill", 'red' );
			//.style('stroke', 'red')
			//.style('stroke-width', '3px');
		d3
			.selectAll('.onenode')
			.filter(function(b){ return temp.includes(b.id); })
			.attr("fill", 'green' );
			//.style('stroke', 'green')
			//.style('stroke-width', '3px');
		d3
			.select('#textname2')
			.text(coverstoshow.filter(function(u){ return u.institution == a; })[0].institution + ' (' + coverstoshow.filter(function(u){ return u.institution == a; })[0].weight + ')');
	};

	function coveronmouseout (b) {d3
		.selectAll('.onenode')
		.attr("fill", function(e) { return color(e.group); });
		//.style('stroke', 'white')
		//.style('stroke-width', '1.5px');
	};

	// FILTER institutions and links size;
	var vizlinksfiltered = filter(vizlinks);
	
	// FILTER the vizlinksdetails BASED ON THE REMAINING vizlinksfiltered
	var sourceandtarget = [];
	vizlinksfiltered.map(function(d){ 
		if (d.source.id === undefined && d.target.id === undefined) { sourceandtarget.push(d.source.concat(d.target)) } else { sourceandtarget.push(d.source.id.concat(d.target.id)) };
	});
	var vizlinksdetailsfiltered = vizlinksdetails.filter(function(e){
		return sourceandtarget.includes(e.source.concat(e.target));
	});
	
	// FIND THE UNIQUE NODES REPRESENTED INTO THE VIZLINKS FILTERED	
	var uniquenodes = vizlinksfiltered
		.map(function(d){ if (d.source.id === undefined) { return d.source } else { return d.source.id }; })
		.concat(vizlinksfiltered
			.map(function(d){ if (d.target.id === undefined) { return d.target } else { return d.target.id }; }))
		.filter(function(x, i, a){ return a.indexOf(x) == i; }); // Keep only the uniques taken from http://stackoverflow.com/questions/11246758/how-to-get-unique-values-in-an-array

	var viznodesfiltered = viznodes.filter(function(d){ return uniquenodes.includes(d.id) });

	var uniquepublishers = viznodesfiltered
		.map(function(d){ return d.group; })
		.filter(function(x, i, a){ return a.indexOf(x) == i; }); // Keep only the uniques taken from http://stackoverflow.com/questions/11246758/how-to-get-unique-values-in-an-array
	
	// TWEAK THE FORCES
	forcestrength = function () { 
		if(vizlinksfiltered.length == 0 || nodevalue.length == 0) { return 1; } 
		else if (nodevalue.includes(allwhat)) { return d3.max([1 / Math.pow(vizlinksfiltered.length, 0.5), minforcestrength]); } 
		else { return d3.max([1 / nodevalue.length, d3.max([1 / Math.pow(vizlinksfiltered.length, 0.5), minforcestrength])]); }};

	// DEFINE THE SCALES BASED ON THE FILTERED INFO (vizlinksfiltered and viznodesfiltered) 
	nodescale = d3.scaleLinear()
		.domain(d3.extent(viznodesfiltered.map(function(d){ return d.nodesize; })))
		.range(nodesradiusrange);

	linkscale = d3.scaleLinear()
		.domain(d3.extent(vizlinksfiltered.map(function(d){ return d.value; })))
		.range(nodeslinksrange);
	
	// UPDATE THE LISTS
	// INSTITUTIONS
	var option = d3
		.select('#paraminstitution')
		.selectAll('li')
		.data(uniquenodes.concat(allwhat).sort(), function(d){ return d; });
	
	option.exit().remove();
	
	var optionenter = option
		.enter()
		.append('li');
	
	optionenter
		.append('input')
		.attr('value', function(d){ return d; })
		.attr('checked', function(d){ if(nodevalue.includes(d)) { return true}; })
		.attr('id', function(d){ return d; })
		.attr('type', 'checkbox');

	optionenter
		.append('label')
		.attr('for', function(d){ return d; })
		.text(function(d){ return d; });

	// PUBLISHERS
	var publi = d3
		.select('#parampublishers')
		.selectAll('li')
		.data(uniquepublishers.concat('All publishers').sort(), function(d){ return d; });
	
	publi.exit().remove();
	
	var publienter = publi
		.enter()
		.append('li');
	
	publienter
		.append('input')
		.attr('value', function(d){ return d; })
		.attr('checked', function(d){ if(publivalue.includes(d)) { return true}; })
		.attr('id', function(d){ return d; })
		.attr('type', 'checkbox');

	publienter
		.append('label')
		.attr('for', function(d){ return d; })
		.text(function(d){ return d; });

	// LINKS
	var link = svg
		.select(".alllinks")
		.selectAll(".onelink")
		.data(vizlinksfiltered, function(d){ return d.groupsource.concat(d.grouptarget); });

	link.exit().remove();

	linkupd = link
		.enter()
			.append("line")
			.attr('class', "onelink")
		.merge(link)
			.style('stroke', '#999')
			.style('stroke-opacity', linkopacity_off)
			.attr("stroke-width", function(e) { return linkscale(e.value); }) 
			.on("mouseover", function(d){
				d3
					.select(this)
					.transition()
					.style('stroke', '#999')
					.style('stroke-opacity', linkopacity_on);
				d3
					.select('#textname2')
					.text(start_nb)
					.transition()
					.duration(500)
					//Taken from Bostock's "Text Transition I" - Used for animating the nb of shared books.
					.tween("text", function() {
						var that = d3.select(this);
						var i = d3.interpolateNumber(start_nb, d.value);
						return function(t) {
							that.text(Math.round(i(t)));
						};
					});
				d3
					.selectAll(".nodetext")
					.filter(function(e){ return e.id == d.source.id || e.id == d.target.id; })
					.transition()
					.style('font-size', '120%')
					.style("opacity", labelopacity_on)
					.text(function(e){ return e.id; });	
			})
			.on("mouseout", function(d){
				d3
					.select(this)
					.transition()
					.style('stroke', '#999')
					.style('stroke-opacity', linkopacity_off);
				//d3
				//	.select('#textname1')
				//	.text( '-');
				d3
					.select('#textname2')
					.transition()
					.text('-');
				d3
					.selectAll(".nodetext")
					.filter(function(e){ return e.id == d.source.id || e.id == d.target.id; })
					.transition()
					.style('font-size', '50%')
					.style("opacity", labelopacity_off)
					.text(function(e){ return e.id.substring(0, nbcharintitle); });
			})
			.on('click', function(d){
				var coverstoshow = [];
				vizlinksdetailsfiltered.map(function(u){ if (u.source.concat(u.target) == d.source.id.concat(d.target.id)) { coverstoshow.push({institution: u.institution, weight: u.value}); }})
				coverstoshow = coverstoshow.sort(function(a, b){ 
					var weighta = a.weight, weightb = b.weight
					if (weightb - weighta > 0) return 1
					if (weighta - weightb < 0) return -1
					return 0 }).slice(0, nbcoverstoshow);
				
				var covers = d3
					.select('.allcovers')
					.selectAll('rect') //image
					.data(coverstoshow.map(function(e){ return e.institution; }), function(u){ return u; });
				covers
					.exit()
					.transition()
					.duration(1000)
					.attr('opacity', 1e-6)
					.attr('x', width)
					.remove();
				covers
					.enter()
					.append("rect")//image
					.attr('x', 0)
					.attr('y', cover_y)
					.attr('opacity', 1e-6)
					.attr('width', coverwidth)
					.attr('height', coverheight)
					.attr('fill', function(u) { return iidcolor(u); })
					//.attr("xlink:href", function(u) { return u })
					.on('mouseover', function(a){ coveronmouseover(a, coverstoshow); })
					.on('mouseout', function(b){ coveronmouseout(b); })
					.transition()
					.duration(1000)
					.attr('opacity', 1)
					.attr('x', function(u, i) { return i * spacebtw2covers});
				// Obligé de répéter le 'on mouseover' et 'on mouseout' car .merge(covers) pas utilisable à cause des deux transitions.
				covers
					.on('mouseover', function(a){ coveronmouseover(a, coverstoshow); })
					.on('mouseout', function(b){ coveronmouseout(b); })				
					.transition()
					.duration(1000)
					.attr('opacity', 1)
					.attr('x', function(u, i) { return i * spacebtw2covers});
			});

	// NODES CIRCLES
	groupnode = svg
		.select(".allnodes")
		.selectAll(".onenode")
		.data(viznodesfiltered, function(d){ return d.id; });

	groupnode.exit().remove();

	groupnodeupd = groupnode
		.enter()
		.append("circle")
		.attr("class", "onenode")
		.call(d3.drag()
			.on("start", dragstarted)
			.on("drag", dragged)
			.on("end", dragended))
		.attr("fill", function(d) { return color(d.group); })
		.merge(groupnode)
		.attr("r", function(a) { return nodescale(a.nodesize); })
		.on("mouseover", function(d){
			if (!d3.event.active) {simulation.stop()};
			d3
				.select('.allnodes')	
				.append('pattern')
				.attr('id', function(){ return 'id' + d.docid; })
				.attr("width", 1)
				.attr("height", 1)
				.attr('patternContentUnits', 'objectBoundingBox')
				.append('image')
				.attr("xlink:href", d.cover_url)
				.attr("width", 1)
				.attr("height", 1)
				.attr("x", 0)
				.attr("y", 0);
				//.attr("preserveAspectRatio", "xMinYMin slice");
			d3
				.selectAll(".nodetext")
				.filter(function(e){ return e.id == d.id; })
				.transition()
				.style('font-size', '120%')
				.style("opacity", labelopacity_on)
				.attr('dy', function(e){ return d.y + nodesradiusonhover + 10; } )
				.text(function(e){ return e.id + ' (' + e.nodesize + ')'; });
			d3
				.select(this)
				.style('fill', function(){ return 'url(#' + 'id' + d.docid + ')'; })
				.transition()
				.attr("r", nodesradiusonhover);
			d3
				.selectAll(".onelink")
				.filter(function(e){ return d.id == e.source.id || d.id == e.target.id; })
				.transition()
				.style('stroke', function(e){ return color(d.group); })
				.style('stroke-opacity', function(e){ return linkopacity_on; });

			d3
				.select('#textname2')
				.text(start_nb)
				.transition()
				.duration(500)
				//Taken from Bostock's "Text Transition I" - Used for animating the nb of shared books.
				.tween("text", function() {
					var that = d3.select(this);
					var i = d3.interpolateNumber(start_nb, d.nodesize);
					return function(t) {
						that.text(Math.round(i(t)));
					};
				});
			/*d3
				.select('.allcovers')	
				.append("image")
				.attr('x', function(e){console.log(e); console.log(d); return d.x})
				.attr('y', d.x)
				.attr('opacity', 1e-6)
				.attr('width', coverwidth)
				.attr('height', coverheight)
				.attr("xlink:href", d.id)
				.transition()
				.duration(750)
				.attr('opacity', 1);*/
			
			/*d3
				.select("#tooltip")
				.style("opacity", 1)	
				.style("left", d.x + "px")
				.style("top", d.y + "px");
				//.style("background", 'white');
			d3
				.select("#t_cover")
				.select ("img")
				.attr("src", d.id)
				.style("margin-top", 1 + "px")
				.style("margin-right", 1 + "px");*/
		})
		.on("mouseout", function(d){
			simulation.restart();
			d3
				.selectAll(".nodetext")
				.filter(function(e){ return e.id == d.id; })
				.transition()
				.style('font-size', '50%')
				.style("opacity", labelopacity_off)
				.text(function(e){ return e.id.substring(0, nbcharintitle); });
			d3
				.select(this)
				.style('fill', null)				
				.transition()
				.attr("r", function(a) { return nodescale(a.nodesize); });
			d3
				.selectAll(".onelink")
				.filter(function(e){ return d.id == e.source.id || d.id == e.target.id; })
				.transition()
				.style('stroke', '#999')
				.style('stroke-opacity', linkopacity_off);
			d3
				.select('#textname2')
				.transition()
				.text('-');
			d3
				.select('.allnodes')
				.select('pattern')
				.remove();
			/*d3
				.select('.allcovers')
				.select('image')
				.remove();*/
		})
		.on("click", function(d){
			var coverstoshow = [];
				viznodesdetails.map(function(u){ if (u.id == d.id) { coverstoshow.push({institution: u.institution, weight: u.value}); }})
				coverstoshow = coverstoshow.sort(function(a, b){ 
					var weighta = a.weight, weightb = b.weight
					if (weightb - weighta > 0) return 1
					if (weighta - weightb < 0) return -1
					return 0 }).slice(0, nbcoverstoshow);

				var covers = d3
					.select('.allcovers')
					.selectAll('rect')//image
					.data(coverstoshow.map(function(e){ return e.institution; }), function(u){ return u; });
				covers
					.exit()
					.transition()
					.duration(1000)
					.attr('opacity', 1e-6)
					.attr('x', width)
					.remove();
				covers
					.enter()
					.append("rect") //image
					.attr('x', 0)
					.attr('y', cover_y)
					.attr('opacity', 1e-6)
					.attr('width', coverwidth)
					.attr('height', coverheight)
					.attr('fill', function(u) { return iidcolor(u); })
					//.attr("xlink:href", function(u) { return u })
					.on('mouseover', function(a){ coveronmouseover(a, coverstoshow); })
					.on('mouseout', function(b){ coveronmouseout(b); })					
					.transition()
					.duration(1000)
					.attr('opacity', 1)
					.attr('x', function(u, i) { return i * spacebtw2covers});
				covers
					.on('mouseover', function(a){ coveronmouseover(a, coverstoshow); })
					.on('mouseout', function(b){ coveronmouseout(b); })					
					.transition()
					.duration(1000)
					.attr('opacity', 1)
					.attr('x', function(u, i) { return i * spacebtw2covers});
		});

	// TEXT NODES
	textnode = svg
		.select(".alltextnodes")
		.selectAll(".nodetext")
		.data(viznodesfiltered, function(d){ return d.id; });

	textnode.exit().remove();

	textnodeupd = textnode
		.enter()
		.append("text")
		.attr('class', "nodetext")
		.merge(textnode)
		.attr('text-anchor', "middle")
		.style("opacity", labelopacity_off)
		.style("pointer-events", "none")
		.text(function(d) { return d.id.substring(0, nbcharintitle) });

	// PARAM FILTER LINK VALUE
	d3
		.select("#paramlinklabel")
		.property('value', linkvalue)
		.on("change", function() {
			linkvalue = d3.max([+this.value, minlinkvalue()]);
			d3
				.select("#paramlinkvalue")
				.property("value", linkvalue);
			update(viznodes, vizlinks, vizlinksdetails, data);
		});
	d3
		.select("#paramlinkvalue")
		.attr('min', minlinkvalue)
		.attr('max', maxlinkvalue)
		.attr('value', linkvalue)
		.on("input", function() {
			linkvalue = d3.max([+this.value, minlinkvalue()]);
			// Update the label
			d3
				.select("#paramlinklabel")
				.property('value', linkvalue);
			update(viznodes, vizlinks, vizlinksdetails, data);
		});
	d3
		.selectAll("#paraminstitution input")
		.on("click", function() {
			var index = nodevalue.indexOf(this.value);
			if( index == -1) {
				nodevalue.push(this.value);
			} else {nodevalue.splice(index, 1);};
			if(this.value == allwhat || !(nodevalue.includes(allwhat))) { update(viznodes, vizlinks, vizlinksdetails, data); };
		});
	d3
		.selectAll("#parampublishers input")
		.on("click", function() {
			var index = publivalue.indexOf(this.value);
			if( index == -1) {
				publivalue.push(this.value);
			} else {publivalue.splice(index, 1);};
			if(this.value == 'All publishers' || !(publivalue.includes('All publishers'))) { detail(data); };
		});	

	// RUN THE FORCES

	simulation
		.nodes(viznodesfiltered) //Replace with 'viznodesfiltered' if update of forces is needed while filter is changing - 'viznodes' otherwise
		.on("tick", ticked);

	simulation
		.force("link")
		.links(vizlinksfiltered); //Replace with 'vizlinksfiltered' if update of forces is needed while filter is changing - 'vizlinks' otherwise

	simulation.alpha(0.5).restart();

};

function ticked() {
	var radius = nodesradiusrange[1];
	function xlim (a) { return Math.max(radius, Math.min(width - radius, a)); };
	function ylim(b) { return Math.max(radius + coverheight, Math.min(height - radius, b)); };
	
	//console.log(simulation.alpha());
	groupnodeupd
		.attr("cx", function(d) { return xlim(d.x); })
		.attr("cy", function(d) { return ylim(d.y); });

	textnodeupd
			.attr("dx", function(d){ return xlim(d.x); })
			.attr("dy", function(d){ return ylim(d.y + nodescale(d.nodesize) ); });

	linkupd
		.attr("x1", function(d) { return xlim(d.source.x); })
		.attr("y1", function(d) { return ylim(d.source.y); })
		.attr("x2", function(d) { return xlim(d.target.x); })
		.attr("y2", function(d) { return ylim(d.target.y); });
};

function dragstarted(d) {
	
	if (!d3.event.active) 
		simulation.alphaTarget(0.3).restart();
	d.fx = d.x;
	d.fy = d.y;
};

function dragged(d) {
	d.fx = d3.event.x;
	d.fy = d3.event.y;
};

function dragended(d) {
	if (!d3.event.active) 
	simulation.alphaTarget(0);
	d.fx = null;
	d.fy = null;
};


// FUNCTION USED FOR DETAIL OF NODES AND LINKS
function detail(data){
	//console.log(data);
	
	// Only way I found to copy an array without leaving references 
	var copylinks = JSON.parse(JSON.stringify(data.links_sim));
	var copynodes = JSON.parse(JSON.stringify(data.nodes));
	viznodes = [];
	vizlinks = [];
	
	// THE NODES
	viznodes = copynodes.filter(function(u){ return true; });

	// 0 - Filter the nodes
	viznodes = viznodes.filter(function(d){
			if (publivalue.includes('All publishers')) { return true; } else { return publivalue.includes(d.group); };
		});
	
	// 1 - Create viznodesdetails in order to hold the books' urls
	viznodesdetails = [];
	viznodes.map(function(e){
		viznodesdetails.push(e);
	});

	// 2 - aggregate by iid and sum over the value
	//MODIF
	viznodes = d3
		.nest()
		.key(function(u) { return u.id + "|" + u.group + "|" + u.docid + "|" + u.cover_url; })
		.rollup(function(u){ return d3.sum(u, function(e){ return 1; }) })
		.entries(viznodes);

	// 3 - recreate the initial format and rename the columns
	viznodes.map(function(u) {
		u.id = u.key.split("|")[0];
		u.group = u.key.split("|")[1];
		u.docid = u.key.split("|")[2];
		u.cover_url = u.key.split("|")[3];
		u.nodesize = u.value;
		delete u.key;
		delete u.value;
	});

	// THE LINKS
	vizlinks = copylinks.filter(function(u){ return true; });
	
	// 1 - Filter the links
	vizlinks = vizlinks.filter(function(d){
		if (publivalue.includes('All publishers')) { return true; } else { return publivalue.includes(d.groupsource) && publivalue.includes(d.grouptarget); };
		});
	// 3 - Create vizlinksdetails in order to hold the books' urls
	vizlinksdetails = [];
	vizlinks.map(function(e){
		vizlinksdetails.push(e);
	}); 


	// 4 - Aggregate the links using "|" as a separator
	vizlinks = d3
		.nest()
		.key(function(u) { return u.groupsource + "|" + u.grouptarget + "|" + u.source + "|" + u.target; })
		.rollup(function(u){ return d3.sum(u, function(e){ return 1; }) })
		.entries(vizlinks);
	
	// 5 - Split the key and recreate the four initial fields.
	vizlinks.map(function(u) {
		u.groupsource = u.key.split("|")[0];
		u.grouptarget = u.key.split("|")[1];
		u.source = u.key.split("|")[2];
		u.target = u.key.split("|")[3];
		delete u.key;
	});

	// update the graphe
	update(viznodes, vizlinks, vizlinksdetails, data);
};

// READ THE GRAPH DATASET
d3.json(dataset, function(error, data) {
	if (error) return console.warn(error);
	detail(data);
});


</script>
</body>